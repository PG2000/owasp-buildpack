#!/bin/bash
# This script provides dependencies for an app


set -euo pipefail

BUILD_DIR=$1
CACHE_DIR=$2
DEPS_DIR=$3
DEPS_IDX=$4

echo $BUILD_DIR

ls -lah $BUILD_DIR

GO_SHA256="a418ce895c8bf3ca2e7b2f423f038b8b093941684c9430f2e40da0982e12b52d"
URL=https://github.com/AdoptOpenJDK/openjdk8-binaries/releases/download/jdk8u222-b10/OpenJDK8U-jre_x64_linux_hotspot_8u222b10.tar.gz

echo "-----> Download java"
curl -s -L --retry 15 --retry-delay 2 $URL -o $CACHE_DIR/java.tar.gz
tar xzf $CACHE_DIR/java.tar.gz -C $CACHE_DIR/
chmod +x $CACHE_DIR/jdk8u222-b10-jre/bin/java
$CACHE_DIR/jdk8u222-b10-jre/bin/java -version

URL_CHECK=https://dl.bintray.com/jeremy-long/owasp/dependency-check-5.2.1-release.zip
curl -s -L --retry 15 --retry-delay 2 $URL_CHECK -o $CACHE_DIR/depcheck.zip

unzip $CACHE_DIR/dependency-check-5.2.1-release.zip -d $CACHE_DIR/

find $CACHE_DIR

echo "##################################################"

env

echo "##################################################"

echo $CACHE_DIR

echo $DEPS_DIR

echo $DEPS_IDX

export BUILDPACK_DIR=`dirname $(readlink -f ${BASH_SOURCE%/*})`
source "$BUILDPACK_DIR/scripts/install_go.sh"
output_dir=$(mktemp -d -t supplyXXX)
echo "-----> Running go build supply"
GOROOT=$GoInstallDir/go GOPATH=$BUILDPACK_DIR $GoInstallDir/go/bin/go build -o $output_dir/supply owasp/supply/cli
$output_dir/supply "$BUILD_DIR" "$CACHE_DIR" "$DEPS_DIR" "$DEPS_IDX"
