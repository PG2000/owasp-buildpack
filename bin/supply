#!/bin/bash
# This script provides dependencies for an app


set -uo pipefail

BUILD_DIR=$1
CACHE_DIR=$2
DEPS_DIR=$3
DEPS_IDX=$4


if [ "$OWASP_ENABLED" == "false" ]; then
   echo "################## OWASP DISABLED  ################################################";
   exit 0;
fi

echo "################## Start OWASP Scanning ###############################################"

GO_SHA256="a418ce895c8bf3ca2e7b2f423f038b8b093941684c9430f2e40da0982e12b52d"
URL=https://github.com/AdoptOpenJDK/openjdk8-binaries/releases/download/jdk8u222-b10/OpenJDK8U-jre_x64_linux_hotspot_8u222b10.tar.gz

echo "-----> Download java"
curl -s -L --retry 15 --retry-delay 2 $URL -o $CACHE_DIR/java.tar.gz
tar xzf $CACHE_DIR/java.tar.gz -C $CACHE_DIR/
chmod +x $CACHE_DIR/jdk8u222-b10-jre/bin/java
$CACHE_DIR/jdk8u222-b10-jre/bin/java -version

URL_CHECK=https://dl.bintray.com/jeremy-long/owasp/dependency-check-5.2.1-release.zip
curl -s -L --retry 15 --retry-delay 2 $URL_CHECK -o $CACHE_DIR/depcheck.zip

export JAVA_HOME=$CACHE_DIR/jdk8u222-b10-jre/

unzip -q -o $CACHE_DIR/depcheck.zip -d $CACHE_DIR/

chmod +x $CACHE_DIR/dependency-check/bin/dependency-check.sh

$CACHE_DIR/dependency-check/bin/dependency-check.sh -l $CACHE_DIR/dependency-check/log --format JSON --project "security-check" --failOnCVSS 1 --scan $BUILD_DIR/
status=$?
echo "################## End OWASP Scanning #################################################"

echo "################## OWASP Scanning Result ##############################################"

ls -lah
for i in $(cat dependency-check-report.json | jq -r ".dependencies | .[] | select(.vulnerabilities != null) | .fileName")
do
  echo "Found vulnerability for $i"
done
echo "################## OWASP Scanning Result ##############################################"
exit $status